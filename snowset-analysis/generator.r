
# Q200 Database sizes
qres_db = dbGetQuery(con, "
    select databaseid, max(scanbytes) as size
    from classification_day
    group by databaseid
    having max(scanbytes) > 1e9
")
db_sizes=c(1000000000,1000000000,1000000000,1000000000,1000000000,1000000000,1000000000,1000000000,1000000000,2000000000,2000000000,2000000000,2000000000,3000000000,3000000000,3000000000,4000000000,4000000000,5000000000,5000000000,6000000000,6000000000,7000000000,7000000000,8000000000,9000000000,10000000000,10000000000,11000000000,12000000000,13000000000,14000000000,15000000000,16000000000,17000000000,19000000000,20000000000,21000000000,23000000000,24000000000,26000000000,28000000000,30000000000,32000000000,34000000000,36000000000,38000000000,41000000000,44000000000,47000000000,50000000000,53000000000,57000000000,60000000000,64000000000,69000000000,73000000000,78000000000,83000000000,89000000000,95000000000,102000000000,109000000000,116000000000,124000000000,133000000000,143000000000,153000000000,164000000000,176000000000,190000000000,205000000000,220000000000,238000000000,258000000000,278000000000,302000000000,327000000000,355000000000,388000000000,423000000000,463000000000,507000000000,559000000000,619000000000,683000000000,757000000000,845000000000,955000000000,1082000000000,1243000000000,1422000000000,1661000000000,1951000000000,2311000000000,2834000000000,3596000000000,4665000000000,6500000000000,10127000000000)
p1 = ggplot(data=qres_db) + geom_histogram(aes(x=log10(size)), bins = 30) + scale_x_continuous(limits = c(8, 16)); p1
p2 = ggplot(data=data.frame(size_gen = db_sizes)) + geom_histogram(aes(x=log10(size_gen)),bins = 30) + scale_x_continuous(limits = c(8, 16)); p2
grid.arrange(p1, p2, ncol=1)


# Q201 CPU time per query per database size and count .. kind a
qres_cpu = dbGetQuery(con, "with database_sizes as (
    select databaseid, max(scanbytes) as size
    from classification_day
    group by databaseid
    having max(scanbytes) > 0)

select 'snowset' as name, warehouseid, power(10, round(log(size))) as dbsize, count(*) as cnt, sum(cputime) as cputime
from database_sizes,
     classification_day c
where database_sizes.databaseid = c.databaseid
and size >= 1e9
group by warehouseid, power(10, round(log(size)));
")

cpu_times=c(37677922,15808576,378022019,13771757021,4160973926,22719167137,182294919852,12834942,39016443688,6993491,577445432,4693536440,313282630,117560988502,438234083,58182134058,4816746826,11656536229,360514938,16107246325,19332887,157805563843,3166142125,1533690962,392826516,2453042134,1534051641,7726013992,2360387724,8325996260,3827358,6491418376,253778950,68618798371,9011614268,181108937,165144546,592094921,35872471163,92516988,3477056,2631156575887,1611588722,86357833,467130736,1112451911,42413767216,85853606544,19063216191,4589867667161,83057933823,81512475,477917361648,91720481,3772146092,33801391093,8307043064,8111433977,70530768,18207139600,769655875368,192862132,1627263246271,244483258,3132333293,21901893668,960375369,21956119306,102244802440,11422276640,9332644461,8459122875,345900076,34233570670,11017326338890,1446083,94530105901,14110213513,27781151442,17475756483,282737940124,83558706927,32594144674579,18129817825,482456562850,5900348356,49532703886,2892453002,123314118,1816435509,294923001381,1926366670694,132132634445,80162306632,68457374,79881407,30383096793975,515606449174,1001922097,1292968221584)
size_buckets=c(9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13)
qres_gen = data.frame(cpu_times, size_buckets)

cpu_times_x=c(37677922,15808576,378022019,13771757021,4160973926,22719167137,182294919852,12834942,39016443688,6993491,577445432,4693536440,313282630,117560988502,438234083,58182134058,4816746826,11656536229,360514938,16107246325,19332887,157805563843,3166142125,1533690962,392826516,2453042134,1534051641,7726013992,2360387724,8325996260,3827358,6491418376,253778950,68618798371,9011614268,181108937,165144546,592094921,35872471163,92516988,3477056,2631156575887,1611588722,86357833,467130736,1112451911,42413767216,85853606544,19063216191,4589867667161,83057933823,81512475,477917361648,91720481,3772146092,33801391093,8307043064,8111433977,70530768,18207139600,769655875368,192862132,1627263246271,244483258,3132333293,21901893668,960375369,21956119306,102244802440,12018303231,9998975645,9143222045,497843380,32646812368,6263776840821,3399541,82308400705,14568086014,26993782618,17700391142,223169858188,73563975432,16815222902373,18302519516,363011912234,6586669810,45699211078,3441826600,194661632,2253417233,231909538463,1280383148734,83243818130,58494530084,398681458,444578083,3870157277737,217687516165,2651205670,416610193206)
size_buckets_x=c(9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13)
qres_gen_x = data.frame(cpu_times=cpu_times_x, size_buckets=size_buckets_x)


sum(sqldf("select cpu_times as cputime from qres_gen order by cpu_times desc limit 10")) / 1e6 / 3600


summary(qres_cpu$cputime / 1e6)
summary(cpu_times / 1e6)
sum(qres_cpu$cputime / 1e6 / 3600)
sum(cpu_times / 1e6 / 3600)

all_df = rbind(sqldf("select 'generated' as name, power(10, size_buckets) as dbsize, cpu_times as cputime from qres_gen"),
               sqldf("select 'generated_x' as name, power(10, size_buckets) as dbsize, cpu_times as cputime from qres_gen_x"),
               sqldf("select name, dbsize, cputime from qres_cpu"));

ggplot(data=all_df) + geom_density(aes(x=log(cputime))) + facet_grid(vars(name))
ggplot(data=all_df) + geom_density(aes(x=log(dbsize))) + facet_grid(vars(name))


sqldf("select distinct dbsize from qres_cpu where dbsize = 1e11")
only = sqldf("select * from qres_cpu where dbsize = 1e11 and cputime > 0")
mean(log(only$cputime))
sd(log(only$cputime))

p1 = ggplot(data=qres_cpu) + geom_density(aes(x = log(cputime))) + scale_x_continuous(breaks=seq(1, 30), limits=c(9,30)); p1
p2 = ggplot(data=data.frame(x=rnorm(100, mean(log(only$cputime)), sd(log(only$cputime))))) + geom_density(aes(x = x)) + scale_x_continuous(breaks=seq(1, 30), limits=c(9,30)); p2
p3 = ggplot(data=data.frame(cputime=cpu_times)) + geom_density(aes(x = log(cputime))) + scale_x_continuous(breaks=seq(1, 30), limits=c(9,30)); p3


grid.arrange(p1, p2, p3, ncol=1)

p1 = ggplot(data=data.frame(gen_bucket=size_buckets)) + geom_histogram(aes(x=gen_bucket)) + scale_x_continuous(limits=c(8,14)); p1
p2 = ggplot(data=data.frame(bucket=log(qres_cpu$dbsize) / log(10))) + geom_histogram(aes(x=bucket)) + scale_x_continuous(limits=c(8,14)); p2
grid.arrange(p1, p2, ncol=1)

ggplot(data=data.frame(cpu_times, size_buckets)) + geom_density(aes(x=log(cpu_times))) + facet_wrap(~size_buckets, scales = "free_y", ncol = 1)



# Test plot 
original_df = sqldf("select 'original' as name, cnt from qres_cpu")
query_counts=c(11,24,11,47,28,2,87,9143,1760,168,4278,2744,3173,369,1344,83,290,124,10,146,11932,2932,520,50,15,57,228,13594,304,5645,6,29,1581,81,3,116,3042,87,159,11,1552,5769,810,1632,48,724,415,15,20,58,356,265,5,6621,270,14946,26,3,3,80,311,2,87,484,4311,842,111,16811,1189,11,2,636,52,142,114,36,12,787,2240,160,1121,11,7,203,1,9,6,78,36,1130,13768,161,9,58,6212,13364,31,102,408,59)
generated_df = data.frame(name = rep('generated', length(query_counts)), cnt = query_counts)
new <- rbind(original_df, generated_df)
ggplot(data=new) + geom_density(aes(x = log(cnt) / log(10))) + facet_wrap(~name, ncol=1)



ggplot(data=data.frame(x = exp(rnorm(1000)))) + geom_density(aes(x = x)) + scale_x_log10(breaks = seq(1,20))


